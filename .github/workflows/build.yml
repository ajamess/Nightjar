name: Build Releases

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'dev'

permissions:
  contents: write
  packages: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Sync version from git tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          $tag = "${{ github.ref_name }}"
          Write-Host "Syncing version from tag: $tag"
          node scripts/sync-version.js --tag $tag
        shell: pwsh

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Build frontend
        run: npm run build
        env:
          VITE_GITHUB_PAT: ${{ secrets.VITE_GITHUB_PAT }}

      - name: Package for Windows
        run: npx electron-builder --win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Nightjar-windows
          path: |
            release/*.exe
            release/*.msi

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Sync version from git tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG="${{ github.ref_name }}"
          echo "Syncing version from tag: $TAG"
          node scripts/sync-version.js --tag "$TAG"

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Build frontend
        run: npm run build
        env:
          VITE_GITHUB_PAT: ${{ secrets.VITE_GITHUB_PAT }}

      - name: Package for macOS
        run: npx electron-builder --mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Nightjar-macos
          path: |
            release/*.dmg
            release/*.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Sync version from git tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG="${{ github.ref_name }}"
          echo "Syncing version from tag: $TAG"
          node scripts/sync-version.js --tag "$TAG"

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Build frontend
        run: npm run build
        env:
          VITE_GITHUB_PAT: ${{ secrets.VITE_GITHUB_PAT }}

      - name: Package for Linux
        run: npx electron-builder --linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Nightjar-linux
          path: |
            release/*.AppImage
            release/*.deb

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: ${{ always() && startsWith(github.ref, 'refs/tags/v') && (needs.build-windows.result == 'success' || needs.build-macos.result == 'success' || needs.build-linux.result == 'success') }}
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Build Docker image on GitHub and push to GHCR
  # ===========================================================================
  build-docker:
    needs: [create-release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/nightjar
          tags: |
            type=semver,pattern={{version}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: server/unified/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # Deploy to VPS â€” pull image from GHCR, deploy landing page + installers
  # ===========================================================================
  deploy-vps:
    needs: [create-release, build-docker]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: find artifacts -type f

      # -- Copy installers to VPS download directory --
      - name: Upload installers to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          source: "artifacts/Nightjar-windows/*,artifacts/Nightjar-macos/*,artifacts/Nightjar-linux/*"
          target: /tmp/nightjar-deploy
          strip_components: 2

      # -- SSH into VPS: pull image, restart containers, deploy static assets --
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -euo pipefail
            REPO="/opt/Nightjar"
            WEB="/var/www/night-jar"
            IMAGE="ghcr.io/${{ github.repository_owner }}/nightjar:latest"

            echo "=== Pulling latest code (for compose file + static assets) ==="
            cd "$REPO"
            git fetch --all --tags
            git checkout "${{ github.ref_name }}"

            echo "=== Logging in to GHCR ==="
            echo "${{ secrets.DEPLOY_GHCR_TOKEN }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

            echo "=== Pulling Docker image ==="
            docker pull "$IMAGE"

            echo "=== Starting containers ==="
            docker compose -f server/deploy/docker-compose.prod.yml up -d --remove-orphans

            echo "=== Deploying landing page ==="
            sudo mkdir -p "$WEB/download"
            sudo cp "$REPO/frontend/public-site/index.html" "$WEB/index.html"
            sudo cp "$REPO/frontend/public/assets/nightjar-logo.png" "$WEB/nightjar-logo.png" 2>/dev/null || true
            sudo cp "$REPO/assets/icons/nightjar-64.png" "$WEB/nightjar-64.png" 2>/dev/null || true

            echo "=== Moving installers to download directory ==="
            WIN_EXE=$(find /tmp/nightjar-deploy -name '*.exe' | head -1)
            [ -n "$WIN_EXE" ] && sudo cp "$WIN_EXE" "$WEB/download/Nightjar-Setup.exe"

            MAC_DMG=$(find /tmp/nightjar-deploy -name '*.dmg' | head -1)
            [ -n "$MAC_DMG" ] && sudo cp "$MAC_DMG" "$WEB/download/Nightjar.dmg"

            LINUX_APPIMAGE=$(find /tmp/nightjar-deploy -name '*.AppImage' | head -1)
            [ -n "$LINUX_APPIMAGE" ] && sudo cp "$LINUX_APPIMAGE" "$WEB/download/Nightjar.AppImage"

            LINUX_DEB=$(find /tmp/nightjar-deploy -name '*.deb' | head -1)
            [ -n "$LINUX_DEB" ] && sudo cp "$LINUX_DEB" "$WEB/download/Nightjar.deb"

            sudo chown -R www-data:www-data "$WEB"

            echo "=== Updating Nginx config ==="
            sudo cp "$REPO/server/deploy/nginx.conf" /etc/nginx/sites-available/night-jar
            sudo nginx -t && sudo systemctl reload nginx

            echo "=== Pruning old Docker images ==="
            docker image prune -f

            echo "=== Cleaning up ==="
            rm -rf /tmp/nightjar-deploy

            echo "=== Deploy complete for ${{ github.ref_name }} ==="
