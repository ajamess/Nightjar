# =============================================================================
# Nginx Configuration — night-jar.co Production Stack
# =============================================================================
#
# Routing:
#   night-jar.co              → Static landing page (/var/www/night-jar)
#   night-jar.co/signal       → Relay server (WebSocket signaling)
#   night-jar.co/health       → Relay server health check
#   night-jar.co/api/mesh/*   → Relay server mesh API
#   night-jar.co/yjs/*        → Relay server y-websocket sync
#   night-jar.co/toot/*       → Private Nightjar instance (pass-through)
#   mail.night-jar.co         → Mailcow (admin UI + SOGo webmail)
#
# Install:
#   cp nginx.conf /etc/nginx/sites-available/night-jar
#   ln -sf /etc/nginx/sites-available/night-jar /etc/nginx/sites-enabled/night-jar
#   rm -f /etc/nginx/sites-enabled/default
#   nginx -t && systemctl reload nginx
#
# SSL:
#   night-jar.co      → Cloudflare Origin Certificate (Full Strict)
#   mail.night-jar.co → Mailcow's own Let's Encrypt certificate
# =============================================================================

# --- Upstreams ---------------------------------------------------------------
upstream relay {
    server 127.0.0.1:3001;
}

upstream private {
    server 127.0.0.1:3002;
}

upstream mailcow {
    server 127.0.0.1:8080;
}

# --- HTTP → HTTPS redirect ---------------------------------------------------
server {
    listen 80;
    server_name night-jar.co www.night-jar.co mail.night-jar.co autodiscover.night-jar.co autoconfig.night-jar.co;
    return 301 https://$host$request_uri;
}

# =============================================================================
# night-jar.co — Landing page + Relay + Private instance
# =============================================================================
server {
    listen 443 ssl http2;
    server_name night-jar.co www.night-jar.co;

    # Cloudflare Origin Certificate (Full Strict mode)
    ssl_certificate     /etc/ssl/cloudflare/night-jar.co.pem;
    ssl_certificate_key /etc/ssl/cloudflare/night-jar.co.key;
    ssl_protocols       TLSv1.2 TLSv1.3;

    # --- Private instance at /toot (MUST be before / location) ---
    # Pass-through: Express handles BASE_PATH=/toot natively
    location /toot/ {
        proxy_pass http://private;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
        client_max_body_size 50m;
    }

    # Exact match for /toot without trailing slash → redirect to /toot/
    location = /toot {
        return 301 /toot/;
    }

    # --- Relay server WebSocket signaling ---
    location = /signal {
        proxy_pass http://relay;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # --- Relay server health check ---
    location = /health {
        proxy_pass http://relay;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # --- Relay server mesh API ---
    location /api/mesh/ {
        proxy_pass http://relay;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Relay server y-websocket sync ---
    location /yjs/ {
        proxy_pass http://relay;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # --- Landing / download page (static files) ---
    location / {
        root /var/www/night-jar;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # --- Security headers ---
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}

# =============================================================================
# mail.night-jar.co — Mailcow (admin UI + SOGo webmail)
# =============================================================================
server {
    listen 443 ssl http2;
    server_name mail.night-jar.co autodiscover.night-jar.co autoconfig.night-jar.co;

    # Mailcow's own Let's Encrypt certificate (auto-renewed by acme-mailcow)
    ssl_certificate     /opt/mailcow-dockerized/data/assets/ssl/cert.pem;
    ssl_certificate_key /opt/mailcow-dockerized/data/assets/ssl/key.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;

    location / {
        proxy_pass http://mailcow;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Port 443;
        proxy_buffering off;
        client_max_body_size 0;
    }
}
