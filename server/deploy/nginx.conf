# =============================================================================
# Nginx Configuration — night-jar.co Production Stack
# =============================================================================
#
# Routing:
#   night-jar.co              → Static landing page (/var/www/night-jar)
#   night-jar.co/join/*       → Relay server (share link SPA)
#   night-jar.co/assets/*     → Relay server (Vite-bundled SPA assets)
#   night-jar.co/api/*        → Relay server (key delivery, persistence check, etc.)
#   night-jar.co/signal       → Relay server (WebSocket signaling)
#   night-jar.co/health       → Relay server health check
#   night-jar.co/yjs/*        → Relay server y-websocket sync
#   night-jar.co/app/*        → Private Nightjar instance (pass-through)
#   mail.night-jar.co         → Mailcow (admin UI + SOGo webmail)
#
# Install:
#   cp nginx.conf /etc/nginx/sites-available/night-jar
#   ln -sf /etc/nginx/sites-available/night-jar /etc/nginx/sites-enabled/night-jar
#   rm -f /etc/nginx/sites-enabled/default
#   nginx -t && systemctl reload nginx
#
# SSL:
#   night-jar.co      → Cloudflare Origin Certificate (Full Strict)
#   mail.night-jar.co → Mailcow's own Let's Encrypt certificate
# =============================================================================

# --- Upstreams ---------------------------------------------------------------
upstream relay {
    server 127.0.0.1:3001;
}

upstream private {
    server 127.0.0.1:3002;
}

upstream mailcow {
    server 127.0.0.1:8080;
}

# --- HTTP → HTTPS redirect ---------------------------------------------------
server {
    listen 80;
    server_name night-jar.co www.night-jar.co mail.night-jar.co autodiscover.night-jar.co autoconfig.night-jar.co;
    return 301 https://$host$request_uri;
}

# =============================================================================
# night-jar.co — Landing page + Relay + Private instance
# =============================================================================
server {
    listen 443 ssl http2;
    server_name night-jar.co www.night-jar.co;

    # Cloudflare Origin Certificate (Full Strict mode)
    ssl_certificate     /etc/ssl/cloudflare/night-jar.co.pem;
    ssl_certificate_key /etc/ssl/cloudflare/night-jar.co.key;
    ssl_protocols       TLSv1.2 TLSv1.3;

    # --- Private instance at /app (MUST be before / location) ---
    # Pass-through: Express handles BASE_PATH=/app natively
    location /app/ {
        proxy_pass http://private;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
        client_max_body_size 50m;
    }

    # Exact match for /app without trailing slash → redirect to /app/
    location = /app {
        return 301 /app/;
    }

    # --- Relay server WebSocket signaling ---
    location = /signal {
        proxy_pass http://relay;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # --- Relay server health check ---
    location = /health {
        proxy_pass http://relay;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # --- Relay server y-websocket sync ---
    location /yjs/ {
        proxy_pass http://relay;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # --- Share link join route ---
    # Proxied to the relay server which serves the SPA.
    # The React app handles the share link client-side via DeepLinkGate.
    # Must be registered BEFORE the catch-all location / block.
    location /join/ {
        proxy_pass http://relay;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Relay SPA assets (Vite-hashed JS/CSS bundles) ---
    # When the SPA is served via /join/, its HTML references /assets/main-xxx.js.
    # Without this block, asset requests fall to the catch-all and return the
    # landing-page HTML instead of JavaScript → blank screen.
    # Vite content-hashes filenames so aggressive caching is safe.
    location /assets/ {
        proxy_pass http://relay;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # --- Relay API (key delivery, encrypted-persistence, bug reports, invites) ---
    # The relay SPA at /join/ makes fetch() calls to /api/rooms/:room/key,
    # /api/encrypted-persistence, /api/bug-report, etc.  These must reach the
    # relay server, not the static landing page.
    # NOTE: /app/api/* is already handled by the /app/ location above (private instance).
    location /api/ {
        proxy_pass http://relay;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Landing / download page + y-websocket catch-all ---
    # WebSocket upgrades at arbitrary paths (e.g. /workspace-meta:abc123)
    # are proxied to the relay for y-websocket sync.
    # Uses the error_page trick because nginx's "if" doesn't mix with try_files.
    location / {
        error_page 418 = @ws_relay;
        if ($http_upgrade = "websocket") {
            return 418;
        }

        # Normal HTTP → static landing page
        root /var/www/night-jar;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # Named location for WebSocket upgrade proxying to relay
    location @ws_relay {
        proxy_pass http://relay;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # --- Security headers ---
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # --- Cache control for screenshots ---
    # Never cache the manifest so new screenshots are picked up immediately
    location = /screenshots/manifest.json {
        root /var/www/night-jar;
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        add_header X-Content-Type-Options "nosniff" always;
    }

    # Screenshot images: short cache so Cloudflare re-validates frequently
    location /screenshots/ {
        root /var/www/night-jar;
        expires 1h;
        add_header Cache-Control "public, max-age=3600, must-revalidate" always;
        add_header X-Content-Type-Options "nosniff" always;
    }
}

# =============================================================================
# mail.night-jar.co — Mailcow (admin UI + SOGo webmail)
# =============================================================================
server {
    listen 443 ssl http2;
    server_name mail.night-jar.co autodiscover.night-jar.co autoconfig.night-jar.co;

    # Mailcow's own Let's Encrypt certificate (auto-renewed by acme-mailcow)
    ssl_certificate     /opt/mailcow-dockerized/data/assets/ssl/cert.pem;
    ssl_certificate_key /opt/mailcow-dockerized/data/assets/ssl/key.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;

    location / {
        proxy_pass http://mailcow;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Port 443;
        proxy_buffering off;
        client_max_body_size 0;
    }
}
