# =============================================================================
# Nightjar Production Stack — night-jar.co
# =============================================================================
#
# Services:
#   1. nightjar-relay   — Public relay server (wss://night-jar.co/signal)
#   2. nightjar-private — Private instance with storage (night-jar.co/app)
#
# The Docker image is built on GitHub Actions and pushed to GHCR.
# This compose file PULLS the pre-built image — no local build needed.
#
# Mailcow runs separately in /opt/mailcow-dockerized (ports 8080/8443).
# Nginx runs on the host and routes everything (see nginx.conf).
# The static landing page is served by nginx from /var/www/night-jar.
#
# Usage:
#   docker login ghcr.io    (one-time, with PAT)
#   docker compose -f docker-compose.prod.yml --env-file .env up -d
#
# The .env file is created automatically by CI/CD and contains GITHUB_PAT.
# To create it manually:  echo "GITHUB_PAT=ghp_xxx" > .env && chmod 600 .env
#
# =============================================================================

services:
  # --------------------------------------------------------------------------
  # Relay Server — lightweight signaling + mesh participation
  # No persistence, no storage — just routes encrypted connections
  # Accessible at night-jar.co/signal, /health, /api/mesh/*, /yjs/*
  # --------------------------------------------------------------------------
  nightjar-relay:
    image: ghcr.io/niyanagi/nightjar:latest
    container_name: nightjar-relay
    restart: unless-stopped
    ports:
      - "127.0.0.1:3001:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      - NIGHTJAR_MODE=relay
      - PUBLIC_URL=wss://night-jar.co
      # Relay has no persistence — don't ask clients to deliver encryption keys
      - ENCRYPTED_PERSISTENCE=false
      # Bug report proxy — auto-submits GitHub issues from the app
      - GITHUB_PAT=${GITHUB_PAT:-}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - nightjar-net

  # --------------------------------------------------------------------------
  # Private Instance — full persistence, no mesh participation
  # Same image, different runtime config (BASE_PATH=/app)
  # Accessible at night-jar.co/app
  # --------------------------------------------------------------------------
  nightjar-private:
    image: ghcr.io/niyanagi/nightjar:latest
    container_name: nightjar-private
    restart: unless-stopped
    ports:
      - "127.0.0.1:3002:3000"
    volumes:
      - nightjar-private-data:/app/server/unified/data
    environment:
      - PORT=3000
      - NODE_ENV=production
      - NIGHTJAR_MODE=private
      # Encrypted persistence is ON by default — documents encrypted at rest
      - ENCRYPTED_PERSISTENCE=true
      # Express uses this to prefix all routes and strip from incoming requests
      - BASE_PATH=/app
      # Bug report proxy — auto-submits GitHub issues from the app
      - GITHUB_PAT=${GITHUB_PAT:-}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/app/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - nightjar-net

volumes:
  nightjar-private-data:
    driver: local

networks:
  nightjar-net:
    driver: bridge
